from django.db import models
from spinedjango.base.models import Base, Dateable
from django.template.defaultfilters import slugify, lower
from django.contrib.contenttypes.models import ContentType
from django.contrib.contenttypes import generic

def get_image_path(instance, filename):
    return 'galleries/%s/%s' % (slugify(instance.gallery.title), filename)

class Gallery(Base):
    content_type = models.ForeignKey(ContentType, default=9) #default to news
    content_type.help_text = 'What type of content to link this to. Typically you will want to use news which is the default.'
    object_id = models.PositiveIntegerField()
    object_id.help_text = 'This is the object id, you can see this in the permalink or the <em>id</em> column in the admin for the news and reviews.'
    content_object = generic.GenericForeignKey('content_type', 'object_id')

    def __unicode__(self):
        count = (GalleryPhoto.objects.filter(gallery=self.id)).count()
        return '%s - %d Photos' % (self.title, count)

    def photos(self):
        return GalleryPhoto.objects.filter(gallery=self.id)


class GalleryPhoto(models.Model):
    image = models.ImageField(upload_to=get_image_path)
    order = models.IntegerField(blank=True, null=True)
    name = models.CharField(blank=True, null=True, max_length=100)
    gallery = models.ForeignKey(Gallery, blank=True, null=True)

    def __unicode__(self):
        return '%s' % self.image

    class Meta:
        ordering = ('order',)
